# Memo

## Raftで用いられるRPC

基本的に下記の２つ（または３つ）のRPCしかない。

- RequestVote RPC：は選挙中に候補者によって開始される。
- AppendEntries RPC：リーダーによって開始され、ログエントリを複製し、ハートビート情報を提供する。
- サーバー間でスナップショットを転送するためのRPC

フォロワーがクラッシュするなどしてRPCに対してのレスポンスを得られない場合は、リーダーは無期限に再施行を繰り返す。<br>
また通常はパフォーマンスのためにサーバーはRPCを並列に発行する。

## 過去のタームのエントリのコミット

Q：下記のように過去のタームのエントリを過半数のサーバーに複製した場合にコミットしたとみなして良いのか。

![Raftのシナリオ](images/memo-1.png)

1. サーバーA~Eがあり、全てのサーバーがログエントリ1を持ち、サーバーAがリーダー
2. サーバーAがログエントリ2を追加し、サーバーBに複製
3. サーバーAがクラッシュ（エントリ2は過半数に複製できていないので未コミット状態）
4. サーバーEがリーダーに選出（C, D, Eから票を得る。A, Bはより新しいエントリ２を持っているので拒否）
5. サーバーEが自身のログにエントリ3を追加して、直後にクラッシュ
6. サーバーAがリーダに選出（E以外から票を得る。Eはより新しいエントリ3を持っているので拒否）
7. サーバーAは引き続きエントリ2をサーバーCに複製（この時点でエントリ2を過半数に複製したことになるがコミットしたとみなせるのか？）

A：この場合、単に過半数に複製したからといってコミットしたとみなすことはできない。たとえば下記のようにその後にエントリ2が消える可能性がある。

1. サーバーAがクラッシュ（エントリ2は過半数に複製済み）
2. サーバーEがリーダーに選出（エントリ3は2よりも新しいので他の全てのサーバーから票を得ることが可能）
3. サーバーEのエントリ3によってエントリ2が上書きされる

Raftの対策：この問題を防ぐため、Raftでは過去のエントリをコミットするには、現在のタームで追加したログエントリを過半数に複製してコミットすることで、間接的に過去のエントリをコミットするという方法をとる。上記の図の(e)のように、サーバーAがエントリ2を過半数に複製した後に、次に現在のタームで新たにエントリ4を追加して、それを過半数に複製すると、その直後にサーバーAがクラッシュしたとしても、過半数のサーバーが最新のエントリ4を持っていて、サーバーEはそれよりも古いエントリ3を持っているのでリーダーには選出されない。そのため、サーバーAがエントリ4を過半数に複製してコミットした時点で、エントリ2もコミットされたとみなすことができる。

現在のタームのエントリのコミット: ちなみに現在のタームのエントリについては、過半数に複製された時点でコミットされたとみなせる。なぜなら前述したようにその後にリーダーがクラッシュしたとしても、過半数のサーバーは最新のエントリを持っているので、古いエントリを持つサーバーはリーダーには選出されず、必ず最新のエントリを持つサーバーがリーダーに選出されるからである。
